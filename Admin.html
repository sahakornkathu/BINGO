<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>BINGO ADMIN</title>
<link rel="icon" href="data:,">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  body { font-family: system-ui; background:#111; color:#fff; padding:20px }
  h1,h2 { margin-top:20px }
  button { padding:6px 12px; margin:4px; cursor:pointer }
  select { padding:6px }
  .card {
    display:inline-flex; align-items:center; justify-content:center;
    width:42px; height:42px; margin:3px;
    border-radius:6px; font-weight:bold; cursor:pointer;
  }
  .available { background:#333 }
  .assigned { background:#2196f3 }
  .bingo { background:#e91e63 }
</style>
</head>
<body>

<h1>üéØ BINGO ADMIN</h1>

<!-- ROOM -->
<section>
  <button onclick="createRoom()">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
  <select id="roomSelect" onchange="selectRoom()"></select>
  <pre id="roomInfo"></pre>
</section>

<hr>

<!-- PLAYERS -->
<section>
  <h2>üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h2>
  <ul id="players"></ul>
</section>

<hr>

<!-- CARDS -->
<section>
  <h2>üé´ ‡πÉ‡∏ö BINGO (‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡∏Å)</h2>
  <div id="cards"></div>
</section>

<hr>

<!-- CONTROL -->
<section>
  <h2>üé≤ ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Å‡∏°</h2>
  <button onclick="drawNumber()">‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç</button>
  <button onclick="newRound()">üîÅ ‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
</section>

<hr>

<!-- WINNER -->
<section>
  <h2>üèÜ ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</h2>
  <div id="winner">‚Äî</div>
</section>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = 'https://gzpvekespgikowgpgnes.supabase.co'
const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6cHZla2VzcGdpa293Z3BnbmVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NDkxODAsImV4cCI6MjA4NDUyNTE4MH0.L8YfyPFbj7gWYvclZGsziknjDapYmdwM3PghEKziZWc'

const db = supabase.createClient(
  SUPABASE_URL,
  SERVICE_ROLE_KEY
)

let currentRoomId = null

/* ================= UTILS ================= */
function randomBingoNumbers() {
  const nums = new Set()
  while (nums.size < 25) {
    nums.add(Math.floor(Math.random()*75)+1)
  }
  return Array.from(nums)
}

/* ================= ROOM ================= */
async function loadRooms() {
  const { data } = await db
    .from('rooms')
    .select('id, room_code, status')
    .order('created_at', { ascending:false })

  document.getElementById('roomSelect').innerHTML =
    '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>' +
    (data||[]).map(r =>
      `<option value="${r.id}">
        ${r.room_code} (${r.status})
      </option>`
    ).join('')
}

async function createRoom() {
  const roomCode = 'BINGO-' + Math.floor(1000+Math.random()*9000)

  const { data:room, error } = await db
    .from('rooms')
    .insert({
      room_code: roomCode,
      status: 'waiting',
      current_round: 1,
      card_limit: 50
    })
    .select()
    .single()

  if (error) return alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö BINGO 50 ‡πÉ‡∏ö
  const cards = []
  for (let i=1;i<=50;i++) {
    cards.push({
      room_id: room.id,
      round: 1,
      card_no: i,
      numbers: randomBingoNumbers(),
      marks: Array(25).fill(false),
      status: 'available'
    })
  }

  await db.from('cards').insert(cards)

  currentRoomId = room.id
  await loadRooms()
  document.getElementById('roomSelect').value = room.id
  loadAll()
}

async function selectRoom() {
  currentRoomId = document.getElementById('roomSelect').value
  if (currentRoomId) loadAll()
}

/* ================= LOAD ================= */
async function loadRoomInfo() {
  const { data } = await db
    .from('rooms')
    .select('*')
    .eq('id', currentRoomId)
    .single()

  document.getElementById('roomInfo').innerText =
`ROOM: ${data.room_code}
STATUS: ${data.status}
ROUND: ${data.current_round}`
}

async function loadPlayers() {
  const { data } = await db
    .from('players')
    .select('id, custom_name, display_name')
    .eq('room_id', currentRoomId)

  document.getElementById('players').innerHTML =
    (data||[]).map(p =>
      `<li>${p.custom_name || p.display_name} | ${p.id}</li>`
    ).join('')
}

async function loadCards() {
  const { data } = await db
    .from('cards')
    .select('*')
    .eq('room_id', currentRoomId)
    .order('card_no')

  document.getElementById('cards').innerHTML =
    (data||[]).map(c =>
      `<div class="card ${c.status}"
        onclick="assignCard('${c.id}')">
        ${c.card_no}
      </div>`
    ).join('')
}

async function loadWinner() {
  const { data } = await db
    .from('winners')
    .select('*, players(custom_name)')
    .eq('room_id', currentRoomId)
    .order('created_at', { ascending:false })
    .limit(1)

  document.getElementById('winner').innerText =
    data?.length
      ? `üéâ ${data[0].players.custom_name} | CARD ${data[0].card_id}`
      : '‚Äî'
}

/* ================= ACTION ================= */
async function assignCard(cardId) {
  const playerId = prompt('‡πÉ‡∏™‡πà PLAYER ID (1 ‡∏Ñ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÉ‡∏ö‡πÑ‡∏î‡πâ)')
  if (!playerId) return

  await db.from('cards')
    .update({ status:'assigned', player_id:playerId })
    .eq('id', cardId)
    .eq('status','available')

  loadCards()
}

async function drawNumber() {
  await db.rpc('draw_bingo_number', { room_id: currentRoomId })
  await db.rpc('auto_check_and_bingo', { room_id: currentRoomId })
}

async function newRound() {
  if (!confirm('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà ?')) return
  await db.rpc('reset_new_round', { room_id: currentRoomId })
  loadAll()
}

async function loadAll() {
  await loadRoomInfo()
  await loadPlayers()
  await loadCards()
  await loadWinner()
}

/* ================= INIT ================= */
loadRooms()
</script>

</body>
</html>
