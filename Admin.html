<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>BINGO ADMIN</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  body { font-family: system-ui; background:#111; color:#fff; padding:20px }
  h1,h2 { margin-top:20px }
  button { padding:6px 12px; margin:4px; cursor:pointer }
  select { padding:6px }
  .card {
    display:inline-flex; align-items:center; justify-content:center;
    width:44px; height:44px; margin:4px;
    border-radius:6px; font-weight:bold; cursor:pointer;
  }
  .available { background:#333 }
  .assigned { background:#2196f3 }
  .bingo { background:#e91e63 }
</style>
</head>
<body>

<h1>üéØ BINGO ADMIN</h1>

<!-- ROOM CONTROL -->
<section>
  <button onclick="createRoom()">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
  <select id="roomSelect" onchange="selectRoom()"></select>
  <div id="roomInfo"></div>
</section>

<hr>

<!-- PLAYERS -->
<section>
  <h2>üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</h2>
  <ul id="players"></ul>
</section>

<hr>

<!-- CARDS -->
<section>
  <h2>üé´ ‡πÉ‡∏ö BINGO</h2>
  <div id="cards"></div>
</section>

<hr>

<!-- CONTROL -->
<section>
  <h2>üé≤ ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏Å‡∏°</h2>
  <button onclick="drawNumber()">‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç</button>
  <button onclick="newRound()">üîÅ ‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
</section>

<hr>

<!-- WINNER -->
<section>
  <h2>üèÜ ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</h2>
  <div id="winner">‚Äî</div>
</section>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = 'https://gzpvekespgikowgpgnes.supabase.co'
const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6cHZla2VzcGdpa293Z3BnbmVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NDkxODAsImV4cCI6MjA4NDUyNTE4MH0.L8YfyPFbj7gWYvclZGsziknjDapYmdwM3PghEKziZWc'

const supabase = supabaseJs.createClient(
  SUPABASE_URL,
  SERVICE_ROLE_KEY
)

let currentRoomId = null

/* ================= ROOMS ================= */
async function loadRooms() {
  const { data } = await supabase
    .from('rooms')
    .select('id, room_code, status')
    .order('created_at')

  document.getElementById('roomSelect').innerHTML =
    '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>' +
    data.map(r =>
      `<option value="${r.id}">
        ${r.room_code} (${r.status})
      </option>`
    ).join('')
}

async function createRoom() {
  const code = 'BINGO-' + Math.floor(Math.random()*9000+1000)

  const { data } = await supabase
    .from('rooms')
    .insert({ room_code: code })
    .select()
    .single()

  currentRoomId = data.id
  await loadRooms()
  document.getElementById('roomSelect').value = currentRoomId
  loadAll()
}

function selectRoom() {
  currentRoomId = document.getElementById('roomSelect').value
  if (currentRoomId) loadAll()
}

/* ================= LOAD DATA ================= */
async function loadRoomInfo() {
  const { data } = await supabase
    .from('rooms')
    .select('*')
    .eq('id', currentRoomId)
    .single()

  document.getElementById('roomInfo').innerText =
    `ROOM: ${data.room_code} | ROUND: ${data.current_round} | STATUS: ${data.status}`
}

async function loadPlayers() {
  const { data } = await supabase
    .from('players')
    .select('id, custom_name, display_name')
    .eq('room_id', currentRoomId)

  document.getElementById('players').innerHTML =
    data.map(p =>
      `<li>${p.custom_name || p.display_name} (ID: ${p.id})</li>`
    ).join('')
}

async function loadCards() {
  const { data } = await supabase
    .from('cards')
    .select('*')
    .eq('room_id', currentRoomId)
    .order('card_no')

  document.getElementById('cards').innerHTML =
    data.map(c =>
      `<div class="card ${c.status}"
        onclick="assignCard('${c.id}')">
        ${c.card_no}
      </div>`
    ).join('')
}

async function loadWinner() {
  const { data } = await supabase
    .from('winners')
    .select('*, players(custom_name)')
    .eq('room_id', currentRoomId)
    .order('created_at', { ascending:false })
    .limit(1)

  if (data.length > 0) {
    document.getElementById('winner').innerText =
      `üéâ ${data[0].players.custom_name} | CARD ${data[0].card_id}`
  } else {
    document.getElementById('winner').innerText = '‚Äî'
  }
}

/* ================= ACTIONS ================= */
async function assignCard(cardId) {
  const playerId = prompt('‡πÉ‡∏™‡πà PLAYER ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡∏Å‡πÉ‡∏ö (1 ‡∏Ñ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ)')
  if (!playerId) return

  await supabase
    .from('cards')
    .update({ status:'assigned', player_id:playerId })
    .eq('id', cardId)
    .eq('status','available')

  loadCards()
}

async function drawNumber() {
  if (!currentRoomId) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô')
  await supabase.rpc('draw_bingo_number', { room_id: currentRoomId })
  await supabase.rpc('auto_check_and_bingo', { room_id: currentRoomId })
}

async function newRound() {
  if (!confirm('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà ?')) return
  await supabase.rpc('reset_new_round', { room_id: currentRoomId })
  loadAll()
}

/* ================= INIT ================= */
async function loadAll() {
  await loadRoomInfo()
  await loadPlayers()
  await loadCards()
  await loadWinner()
}

loadRooms()

/* ================= REALTIME ================= */
supabase.channel('admin-realtime')
  .on('postgres_changes', { event:'*', schema:'public', table:'cards' }, loadCards)
  .on('postgres_changes', { event:'*', schema:'public', table:'winners' }, loadWinner)
  .subscribe()

</script>
</body>
</html>
